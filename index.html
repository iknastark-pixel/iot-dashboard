<!DOCTYPE html>
<html>
<head>
  <title>IoT Environmental Dashboard</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h2>Real-Time Environmental Monitoring</h2>

<canvas id="tempChart" width="400" height="200"></canvas>
<canvas id="humidityChart" width="400" height="200"></canvas>
<canvas id="airChart" width="400" height="200"></canvas>

<script>
  const client = mqtt.connect("ws://broker.emqx.io:8083/mqtt");

  const tempData = [];
  const humidityData = [];
  const airData = [];
  const labels = [];

  function createChart(ctx, label, data, color) {
    return new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: label,
          data: data,
          borderColor: color,
          fill: false
        }]
      },
      options: {
        animation: false,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }

  const tempChart = createChart(
    document.getElementById('tempChart'),
    "Temperature (Â°C)",
    tempData,
    "red"
  );

  const humidityChart = createChart(
    document.getElementById('humidityChart'),
    "Humidity (%)",
    humidityData,
    "blue"
  );

  const airChart = createChart(
    document.getElementById('airChart'),
    "Air Quality",
    airData,
    "green"
  );

  client.on("connect", () => {
    console.log("Connected to MQTT");
    client.subscribe("iot/environment/data");
  });

  client.on("message", (topic, message) => {
    const data = JSON.parse(message.toString());

    const time = new Date().toLocaleTimeString();
    labels.push(time);

    tempData.push(data.temperature);
    humidityData.push(data.humidity);
    airData.push(data.airQuality);

    if (labels.length > 20) {
      labels.shift();
      tempData.shift();
      humidityData.shift();
      airData.shift();
    }

    tempChart.update();
    humidityChart.update();
    airChart.update();
  });
</script>

</body>
</html>
